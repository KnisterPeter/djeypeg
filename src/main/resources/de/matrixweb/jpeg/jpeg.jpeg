JPEG :
  Rule+ #
;

Rule :
  Name WS* COLON Body SEMI WS*
;

Name :
  (!(WS | COLON) .)+
;

Body :
  BodyPart+ WS*
;
BodyPart :
  WS* ChoiceExpression
;

ChoiceExpression :
  SequenceExpression ChoiceExpressionPart*
;
ChoiceExpressionPart :
  '|' WS* SequenceExpression
;

SequenceExpression :
  SequenceExpressionPart1+
;
SequenceExpressionPart1 :
  Terminal WS*
  | AnyCharExpression WS*
  | EndOfInputExpression WS*
  | OperatorExpression WS*
;

OperatorExpression :
    AndPredicateExpression
  | NotPredicateExpression
  | OneOrMoreExpression
  | ZeroOrMoreExpression
  | OptionalExpression
  | AtomicExpression
;

AndPredicateExpression :
  '&' AtomicExpression
;

NotPredicateExpression :
  '!' AtomicExpression
;

OneOrMoreExpression :
  AtomicExpression '+'
;

ZeroOrMoreExpression :
  AtomicExpression '*'
;

OptionalExpression :
  AtomicExpression '?'
;

AtomicExpression :
    SubExpression
  | RuleReferenceExpression
;

SubExpression :
  '(' WS* ChoiceExpression WS* ')'
;

AnyCharExpression :
  '.'
;

EndOfInputExpression :
  '#'
;

RuleReferenceExpression :
  (!RuleReferenceEnd .)+
;
RuleReferenceEnd :
 '+' | '*' | '?' | '|' | QUOTE | '&' | '!' | SEMI | WS | '(' | ')'
;

Terminal :
 QUOTE InTerminalChar? QUOTE
;
InTerminalChar :
  ('\\' '\'' | '\\' '\\' | !QUOTE .)+
;

WS : ' ' | '\n' | '\t' | '\r';
COLON : ':';
SEMI  : ';';
QUOTE : '\'';
