// -----------------------------------------------------------------------------
// 
// The JPEG grammar
// 
// -----------------------------------------------------------------------------
// 
// This is the main entry point into the JPEG grammar.
// 
JPEG :
  GrammarBlock+ EOI
;

// -----------------------------------------------------------------------------

GrammarBlock :
  (Rule | Comment) WS*
;

// -----------------------------------------------------------------------------

Rule :
  RuleName WS* RuleReturns? WS* ':' WS* Body WS* ';' WS*
;

RuleReturns :
  'returns' WS* ReturnTypeName
;

ReturnTypeName :
  ID
;

// -----------------------------------------------------------------------------

RuleName returns MetaString :
  value=ID
;

// -----------------------------------------------------------------------------

Body :
  (ChoiceExpression WS*)+
;

// -----------------------------------------------------------------------------

ChoiceExpression :
  SequenceExpression ChoiceExpressionPart*
;

ChoiceExpressionPart :
  '|' WS* SequenceExpression
;

// -----------------------------------------------------------------------------

SequenceExpression :
  (
    (
      AndPredicateExpression
      | NotPredicateExpression
      | OneOrMoreExpression
      | ZeroOrMoreExpression
      | OptionalExpression
      | AtomicExpression
    )
    WS*
  )+
;

// -----------------------------------------------------------------------------

AndPredicateExpression :
  '&' WS* AtomicExpression
;

// -----------------------------------------------------------------------------

NotPredicateExpression :
  '!' WS* AtomicExpression
;

// -----------------------------------------------------------------------------

OneOrMoreExpression :
  AtomicExpression WS* '+'
;

// -----------------------------------------------------------------------------

ZeroOrMoreExpression :
  AtomicExpression WS* '*'
;

// -----------------------------------------------------------------------------

OptionalExpression :
  AtomicExpression WS* '?'
;

// -----------------------------------------------------------------------------

AtomicExpression :
  EndOfInputExpression
  | AssignableExpression
;

// -----------------------------------------------------------------------------

AssignableExpression :
  (ID WS* AssignOperation WS*)?
  ( SubExpression
  | RangeExpression
  | Terminal
  | AnyCharExpression
  | RuleName
  )
;
AssignOperation :
    '='
  | '+='
;

// -----------------------------------------------------------------------------

SubExpression :
  '(' WS* ChoiceExpression WS* ')'
;

// -----------------------------------------------------------------------------

RangeExpression : 
  '[' RangeExpressionDash? (!']'(RangeExpressionRange | RangeExpressionChar))* ']'
;

RangeExpressionDash :
  '-'
;

RangeExpressionRange : 
  !'-' . '-' !'-' .
;

RangeExpressionChar : 
  !'-' .
;

// -----------------------------------------------------------------------------

AnyCharExpression :
  '.'
;

// -----------------------------------------------------------------------------

EndOfInputExpression :
  'EOI'
;

// -----------------------------------------------------------------------------

Terminal :
  '\'' InTerminalChar? '\''
;

InTerminalChar :
  ('\\' '\'' | '\\' '\\' | !'\'' .)+
;

// -----------------------------------------------------------------------------

Comment :
  '//' (!('\r'? '\n') .)*
;

// -----------------------------------------------------------------------------

// 
// An ID name must start with an letter or underscore and be followed
// by letters, digits or underscores.
// 
ID returns MetaString :
  [a-zA-Z_]([a-zA-Z0-9_])*
;

WS : ' ' | '\n' | '\t' | '\r';
