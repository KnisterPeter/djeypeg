JPEG :
  Rule+ EOI
;

Rule :
  Name WS* COLON WS* Body WS* SEMI WS*
;

Name :
  [a-zA-Z_]([a-zA-Z0-9_])*
;

Body :
  (ChoiceExpression WS*)+
;

ChoiceExpression :
  SequenceExpression ChoiceExpressionPart*
;
ChoiceExpressionPart :
  '|' WS* SequenceExpression
;

SequenceExpression :
  (
    (
      Terminal
      | RangeExpression
      | AnyCharExpression
      | EndOfInputExpression
      | AndPredicateExpression
      | NotPredicateExpression
      | OneOrMoreExpression
      | ZeroOrMoreExpression
      | OptionalExpression
      | AtomicExpression
    )
    WS*
  )+
;

RangeExpression : 
  '[' RangeExpressionDash? (!(']')(RangeExpressionRange | RangeExpressionChar))* ']'
;
RangeExpressionDash :
  '-'
; 
RangeExpressionRange : 
  !('-') . '-' !('-') .
;
RangeExpressionChar : 
  !('-') .
;

AndPredicateExpression :
  '&' WS* AtomicExpression
;

NotPredicateExpression :
  '!' WS* AtomicExpression
;

OneOrMoreExpression :
  AtomicExpression WS* '+'
;

ZeroOrMoreExpression :
  AtomicExpression WS* '*'
;

OptionalExpression :
  AtomicExpression WS* '?'
;

AtomicExpression :
    SubExpression
  | RuleReferenceExpression
;

SubExpression :
  '(' WS* ChoiceExpression WS* ')'
;

AnyCharExpression :
  '.'
;

EndOfInputExpression :
  'EOI'
;

RuleReferenceExpression :
  (!RuleReferenceEnd .)+
;
RuleReferenceEnd :
 '+' | '*' | '?' | '|' | QUOTE | '&' | '!' | SEMI | WS | '(' | ')' | '[' | ']'
;

Terminal :
 QUOTE InTerminalChar? QUOTE
;
InTerminalChar :
  ('\\' '\'' | '\\' '\\' | !QUOTE .)+
;

WS : ' ' | '\n' | '\t' | '\r';
COLON : ':';
SEMI  : ';';
QUOTE : '\'';
